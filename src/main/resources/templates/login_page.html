<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="ISO-8859-1">
  <title>Employee Management System</title>

  <link rel="stylesheet"
        href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
        crossorigin="anonymous">
  <link rel="icon" href="/tab_icon.png"/>
</head>
<body>
<section class="w-100 p-4 d-flex justify-content-center pb-4">
  <form id="loginForm" style="width: 22rem;">
    <h1 class="mb-5 text-center">Login</h1>
    <div class="form-outline mb-4">
      <label class="form-label" for="email">Email address</label>
      <input type="email" id="email" class="form-control" required>
    </div>

    <div class="form-outline mb-4">
      <label class="form-label" for="password">Password</label>
      <input type="password" id="password" class="form-control" required>
    </div>

    <button type="submit" class="btn btn-primary btn-block mb-4">Sign in</button>

    <div class="text-center">
      <p>Not a member? <a  th:href="@{/public/api/createUserForm}" class="btn btn-primary text-white btn-sm mb-3"> Add User </a>
    </div>
  </form>
</section>

<script>
    document.getElementById('loginForm').addEventListener('submit', async function (event) {
        event.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch('/public/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: email,
                    password: password
                })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('token', data.token);
                const userResponse = await fetch('/auth/api/user', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${data.token}`
                    }
                });

                if (userResponse.ok) {
                    const htmlContent = await userResponse.text();
                    document.open();
                    document.write(htmlContent);
                    document.close();
                    window.history.pushState({}, '', '/auth/api/user');
                } else {
                    alert('Failed to load user page');
                }
            } else {
                alert('Login failed');
            }
        } catch (error) {
            console.error('Error during login:', error);
            alert('An error occurred during login. Please try again later.');
        }
    });
</script>
</body>
</html>
